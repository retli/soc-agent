# AI SOC Chat Chrome æ‰©å±•

ä¸€ä¸ªä¼˜é›…çš„ Chrome æ‰©å±•ï¼Œç”¨äºé€šè¿‡ AI API è¿›è¡Œå¯¹è¯ï¼Œæ”¯æŒ MCP (Model Context Protocol) æœåŠ¡é›†æˆã€‚

> è¯¦ç»†æ–‡æ¡£è¯·æŸ¥çœ‹ [DOCUMENTATION.md](./DOCUMENTATION.md)

## åŠŸèƒ½ç‰¹æ€§

- âœ¨ **ä¾§è¾¹æ ç•Œé¢** - æ‰©å±•æ¿€æ´»åå ç”¨æµè§ˆå™¨é¡µé¢å·¦ä¾§ï¼Œä¸é®æŒ¡å†…å®¹
- ğŸ’¬ **å¯¹è¯ç®¡ç†** - æ”¯æŒåˆ›å»ºæ–°å¯¹è¯å’ŒæŸ¥çœ‹å†å²å¯¹è¯
- ğŸ”Œ **MCP æœåŠ¡é›†æˆ** - å¯é…ç½®ç¬¬ä¸‰æ–¹ MCP æœåŠ¡ï¼ˆSSE æ ¼å¼ï¼‰
- ğŸ¤– **Function Calling** - AIåŸç”Ÿå·¥å…·è°ƒç”¨èƒ½åŠ›ï¼Œå‡†ç¡®ç¨³å®š
- ğŸ› ï¸ **æ™ºèƒ½å·¥å…·è°ƒç”¨** - è‡ªåŠ¨è§£ææ„å›¾ï¼Œå¤šå·¥å…·å¹¶è¡Œæ‰§è¡Œ
- ğŸ¨ **ç°ä»£ UI** - ç®€æ´ç¾è§‚çš„ç”¨æˆ·ç•Œé¢
- ğŸ’¾ **æœ¬åœ°å­˜å‚¨** - å¯¹è¯å†å²ä¿å­˜åœ¨æœ¬åœ°

## å®‰è£…æ­¥éª¤

1. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions/`
2. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
3. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
4. é€‰æ‹©æœ¬é¡¹ç›®æ–‡ä»¶å¤¹

## ä½¿ç”¨è¯´æ˜

### 1. é…ç½® Dify API

é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½® Dify APIï¼š

1. ç‚¹å‡»æ‰©å±•å›¾æ ‡æ—çš„"è®¾ç½®"æŒ‰é’®
2. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **API åœ°å€**: Dify API çš„åŸºç¡€åœ°å€ï¼ˆé»˜è®¤ï¼š`https://api.dify.ai/v1`ï¼‰
   - **API Key**: åœ¨ Dify åº”ç”¨è®¾ç½®ä¸­è·å–çš„ API Key
   - **ç”¨æˆ· ID**: å¯é€‰ï¼Œç”¨äºæ ‡è¯†ç”¨æˆ·
3. ç‚¹å‡»"ä¿å­˜è®¾ç½®"

### 2. å¼€å§‹å¯¹è¯

1. ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡
2. ä¾§è¾¹æ å°†ä»å·¦ä¾§æ»‘å‡º
3. åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter æˆ–ç‚¹å‡»"å‘é€"
4. ä½¿ç”¨"æ–°å¯¹è¯"æŒ‰é’®åˆ›å»ºæ–°çš„å¯¹è¯
5. ç‚¹å‡»å¯¹è¯åˆ—è¡¨åˆ‡æ¢ä¸åŒçš„å¯¹è¯å†å²

### 3. é…ç½® MCP æœåŠ¡ï¼ˆå¯é€‰ï¼‰

MCP (Model Context Protocol) æœåŠ¡å¯ä»¥ä¸ºå¯¹è¯æä¾›é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š

1. åœ¨è®¾ç½®é¡µé¢æ‰¾åˆ°"MCP æœåŠ¡é…ç½®"éƒ¨åˆ†
2. ç‚¹å‡»"+ æ·»åŠ  MCP æœåŠ¡"
3. é…ç½®æœåŠ¡ä¿¡æ¯ï¼š
   - **æœåŠ¡åç§°**: è‡ªå®šä¹‰åç§°
   - **SSE ç«¯ç‚¹ URL**: æ”¯æŒ Server-Sent Events çš„æœåŠ¡åœ°å€
   - **è¯·æ±‚æ–¹æ³•**: GET æˆ– POST
4. ä½¿ç”¨å¼€å…³å¯ç”¨/ç¦ç”¨æœåŠ¡
5. ä¿å­˜è®¾ç½®

### 4. Function Calling æ¨¡å¼ï¼ˆæ¨èï¼‰

å¯ç”¨ Function Calling å¯ä»¥è®© AI æ›´å‡†ç¡®åœ°è°ƒç”¨å·¥å…·ï¼š

1. åœ¨è®¾ç½®é¡µé¢æ‰¾åˆ°"MCP æœåŠ¡é…ç½®"åº•éƒ¨
2. å¯ç”¨ **"Function Callingæ¨¡å¼"** å¼€å…³ï¼ˆé»˜è®¤å¼€å¯ï¼‰
3. åŠŸèƒ½ç‰¹ç‚¹ï¼š
   - âœ… ç»“æ„åŒ–å·¥å…·è°ƒç”¨ï¼ˆ100%å‡†ç¡®ï¼‰
   - âœ… æ”¯æŒå¤šå·¥å…·å¹¶è¡Œæ‰§è¡Œ
   - âœ… è‡ªåŠ¨å‚æ•°éªŒè¯
   - âœ… æ™ºèƒ½æ„å›¾è¯†åˆ«

**å·¥ä½œåŸç†ï¼š**
```
ç”¨æˆ·æé—®
  â†“
AIåˆ†ææ„å›¾ â†’ è¿”å›tool_calls
  â†“
ç³»ç»Ÿè·¯ç”±åˆ°MCPæœåŠ¡ â†’ æ‰§è¡Œå·¥å…·
  â†“
ç»“æœè¿”å›AI â†’ ç”Ÿæˆå‹å¥½å›å¤
```

**å…¼å®¹æ¨¡å¼ï¼š** å…³é—­åå°†ä½¿ç”¨ä¼ ç»Ÿçš„æ–‡æœ¬è§£ææ¨¡å¼ï¼ˆå…¼å®¹æ—§ç‰ˆAPIï¼‰

### 5. è‡ªå®šä¹‰é…ç½®å‚æ•°

å¦‚æœä½ éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹æ å®½åº¦ã€åŠ¨ç”»æ—¶é•¿ç­‰å‚æ•°ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

**ä¿®æ”¹æ­¥éª¤ï¼š**
1. æ‰“å¼€ `src/config/defaults.js` æ–‡ä»¶
2. æ‰¾åˆ° `ui` é…ç½®éƒ¨åˆ†
3. ä¿®æ”¹ç›¸åº”çš„å‚æ•°å€¼
4. é‡æ–°åŠ è½½æ‰©å±•ï¼ˆåœ¨ `chrome://extensions/` ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼‰

**å¸¸ç”¨é…ç½®é¡¹ï¼š**

```javascript
ui: {
  // ä¾§è¾¹æ å¤–è§‚é…ç½®
  sidebarWidth: 400,        // ä¾§è¾¹æ å®½åº¦ï¼ˆåƒç´ ï¼‰- å¯è°ƒæ•´èŒƒå›´ï¼š300-800
  animationDuration: 300,   // åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  
  // æ¶ˆæ¯æ ·å¼é…ç½®
  messageFontSize: 14,      // æ¶ˆæ¯å­—ä½“å¤§å°ï¼ˆåƒç´ ï¼‰- å¯è°ƒæ•´èŒƒå›´ï¼š12-18
  messageMaxWidth: 85,      // æ¶ˆæ¯å¡ç‰‡æœ€å¤§å®½åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰- å¯è°ƒæ•´èŒƒå›´ï¼š60-95
  
  // æµå¼å“åº”é…ç½®
  streamChunkDelay: 10,     // æ‰“å­—æœºæ•ˆæœå»¶è¿Ÿï¼ˆ0=æ— å»¶è¿Ÿï¼Œ20=è¾ƒæ…¢ï¼‰
  
  // å¯¹è¯å†å²é…ç½®
  maxMessageHistory: 10,    // å‘é€ç»™AIçš„å†å²æ¶ˆæ¯æ¡æ•°
  
  // MCPå·¥å…·é…ç½®
  maxToolCallsPerTurn: 5,   // æ¯è½®æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°
  
  // AIå»ºè®®è¡ŒåŠ¨é…ç½®
  enableSuggestedActions: true,   // æ˜¯å¦å¯ç”¨å»ºè®®è¡ŒåŠ¨
  autoSendSuggestions: false      // ç‚¹å‡»å»ºè®®åæ˜¯å¦è‡ªåŠ¨å‘é€
}
```

**ç¤ºä¾‹ 1ï¼šè°ƒæ•´ä¾§è¾¹æ å®½åº¦ä¸º 500px**

```javascript
ui: {
  sidebarWidth: 500,  // æ”¹ä¸º 500px
  // å…¶ä»–é…ç½®ä¿æŒä¸å˜...
}
```

**ç¤ºä¾‹ 2ï¼šè°ƒæ•´æ¶ˆæ¯æ ·å¼ï¼ˆæ›´å¤§å­—ä½“ã€æ›´å®½æ¶ˆæ¯å¡ç‰‡ï¼‰**

```javascript
ui: {
  messageFontSize: 16,    // å­—ä½“æ”¹ä¸º 16pxï¼ˆæ›´å¤§ï¼‰
  messageMaxWidth: 90,    // æ¶ˆæ¯å¡ç‰‡å®½åº¦æ”¹ä¸º 90%ï¼ˆæ›´å®½ï¼‰
  // å…¶ä»–é…ç½®ä¿æŒä¸å˜...
}
```

**ç¤ºä¾‹ 3ï¼šé€‚åˆå°å±å¹•çš„ç´§å‡‘é…ç½®**

```javascript
ui: {
  sidebarWidth: 350,      // æ›´çª„çš„ä¾§è¾¹æ 
  messageFontSize: 13,    // æ›´å°çš„å­—ä½“
  messageMaxWidth: 80,    // æ›´çª„çš„æ¶ˆæ¯å¡ç‰‡
  // å…¶ä»–é…ç½®ä¿æŒä¸å˜...
}
```

> **æ³¨æ„ï¼š** ä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œéœ€è¦åœ¨ `chrome://extensions/` é¡µé¢é‡æ–°åŠ è½½æ‰©å±•æ‰èƒ½ç”Ÿæ•ˆã€‚

## é¡¹ç›®ç»“æ„

```
chrome_ext/
â”œâ”€â”€ manifest.json          # æ‰©å±•é…ç½®æ–‡ä»¶
â”œâ”€â”€ background.js          # åå°æœåŠ¡è„šæœ¬
â”œâ”€â”€ content.js            # å†…å®¹è„šæœ¬ï¼ˆæ³¨å…¥ä¾§è¾¹æ ï¼‰
â”œâ”€â”€ sidebar.html          # ä¾§è¾¹æ  HTML
â”œâ”€â”€ sidebar.js            # ä¾§è¾¹æ ä¸»é€»è¾‘
â”œâ”€â”€ sidebar.css           # ä¾§è¾¹æ æ ·å¼
â”œâ”€â”€ options.html          # è®¾ç½®é¡µé¢ HTML
â”œâ”€â”€ options.js            # è®¾ç½®é¡µé¢é€»è¾‘
â”œâ”€â”€ src/                  # æºä»£ç æ¨¡å—
â”‚   â”œâ”€â”€ config/          # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ defaults.js  # é»˜è®¤é…ç½®å€¼
â”‚   â”‚   â””â”€â”€ constants.js # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ services/        # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ ai-api.js    # AI API æœåŠ¡
â”‚   â”‚   â””â”€â”€ mcp-client.js # MCP å®¢æˆ·ç«¯æœåŠ¡
â”‚   â””â”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ storage.js   # å­˜å‚¨ç®¡ç†
â”‚       â”œâ”€â”€ logger.js    # æ—¥å¿—å·¥å…·
â”‚       â”œâ”€â”€ text-formatter.js # æ–‡æœ¬æ ¼å¼åŒ–
â”‚       â”œâ”€â”€ tool-parser.js    # å·¥å…·è§£æå™¨
â”‚       â””â”€â”€ function-call-adapter.js # Function Callingé€‚é…å™¨
â”œâ”€â”€ icons/                # æ‰©å±•å›¾æ ‡
â”‚   â”œâ”€â”€ icon16.png
â”‚   â”œâ”€â”€ icon48.png
â”‚   â””â”€â”€ icon128.png
â””â”€â”€ README.md             # è¯´æ˜æ–‡æ¡£
```

## æŠ€æœ¯æ ˆ

- **Chrome Extension Manifest V3**
- **ES6 Modules** - æ¨¡å—åŒ–ä»£ç ç»„ç»‡
- **åŸç”Ÿ JavaScript** - æ— æ¡†æ¶ä¾èµ–
- **Chrome Storage API** - æœ¬åœ°æ•°æ®å­˜å‚¨
- **Fetch API** - HTTP è¯·æ±‚
- **EventSource** - SSE è¿æ¥

## å¼€å‘è¯´æ˜

### æ¶æ„è®¾è®¡

æœ¬é¡¹ç›®é‡‡ç”¨**æ¨¡å—åŒ–ã€åˆ†å±‚æ¶æ„**ï¼š

1. **é…ç½®å±‚** (`src/config/`)
   - `defaults.js` - é»˜è®¤é…ç½®å’Œå¼€å‘æ¨¡å¼è®¾ç½®
   - `constants.js` - åº”ç”¨å¸¸é‡å’Œæšä¸¾å€¼

2. **æœåŠ¡å±‚** (`src/services/`)
   - `ai-api.js` - AI API é€šä¿¡æœåŠ¡
   - `mcp-client.js` - MCP åè®®å®¢æˆ·ç«¯

3. **å·¥å…·å±‚** (`src/utils/`)
   - `storage.js` - Chrome Storage å°è£…
   - `logger.js` - å¯é…ç½®çš„æ—¥å¿—ç³»ç»Ÿ
   - `text-formatter.js` - æ–‡æœ¬æ ¼å¼åŒ–å·¥å…·
   - `tool-parser.js` - å·¥å…·è°ƒç”¨è§£æå™¨

4. **åº”ç”¨å±‚**
   - `background.js` - åå°æœåŠ¡å·¥ä½œè€…
   - `content.js` - å†…å®¹è„šæœ¬æ³¨å…¥
   - `sidebar.js` - ä¾§è¾¹æ æ ¸å¿ƒé€»è¾‘
   - `options.js` - è®¾ç½®é¡µé¢ç®¡ç†

### ä¸»è¦ç±»

#### `AIChat` (sidebar.js)
- `init()` - åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ
- `createNewConversation()` - åˆ›å»ºæ–°å¯¹è¯
- `sendMessage()` - å‘é€æ¶ˆæ¯å¹¶å¤„ç†å“åº”
- `executeToolFromIntent()` - æ‰§è¡Œå·¥å…·è°ƒç”¨
- `refreshMCPTools()` - åˆ·æ–° MCP å·¥å…·ç¼“å­˜

#### `OptionsManager` (options.js)
- `saveSettings()` - ä¿å­˜æ‰€æœ‰é…ç½®
- `testApiConnection()` - æµ‹è¯• API è¿æ¥
- `testMCPService()` - æµ‹è¯• MCP æœåŠ¡

#### `StorageManager` (src/utils/storage.js)
- `getAIConfig()` / `saveAIConfig()` - AI é…ç½®ç®¡ç†
- `getMCPServices()` / `saveMCPServices()` - MCP æœåŠ¡ç®¡ç†
- `getConversations()` / `saveConversations()` - å¯¹è¯å†å²ç®¡ç†
- `getDevMode()` / `saveDevMode()` - å¼€å‘æ¨¡å¼è®¾ç½®

#### `MCPClient` (src/services/mcp-client.js)
- `getTools()` - è·å–å¯ç”¨å·¥å…·åˆ—è¡¨
- `callTool(name, args)` - è°ƒç”¨æŒ‡å®šå·¥å…·

#### `AIAPIService` (src/services/ai-api.js)
- `sendMessage(messages, options)` - å‘é€èŠå¤©è¯·æ±‚
- `buildMessages(query, history, systemPrompt)` - æ„å»ºæ¶ˆæ¯æ•°ç»„
- `testConnection()` - æµ‹è¯• API è¿æ¥

### å¼€å‘è€…é€‰é¡¹

åœ¨è®¾ç½®é¡µé¢å¯ç”¨**å¼€å‘æ¨¡å¼**å¯ä»¥ï¼š
- åœ¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆDebug / Info / Warn / Errorï¼‰
- å¸®åŠ©è°ƒè¯• MCP æœåŠ¡å’Œ API é—®é¢˜

## MCP æœåŠ¡è¯´æ˜

MCP (Model Context Protocol) æœåŠ¡ä¸ºå¯¹è¯æä¾›é¢å¤–çš„å·¥å…·å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚æœ¬æ‰©å±•æ”¯æŒæ ‡å‡†çš„ **FastMCP** åè®®ï¼ˆJSON-RPC 2.0 over SSEï¼‰ã€‚

### åè®®æ”¯æŒ

1. **FastMCP æ ‡å‡†åè®®**ï¼ˆæ¨èï¼‰
   - åŸºäº JSON-RPC 2.0
   - é€šè¿‡ SSE ä¼ è¾“
   - æ”¯æŒ `tools/list` æ–¹æ³•è·å–å·¥å…·åˆ—è¡¨

2. **å›é€€å…¼å®¹**
   - REST API: `GET {baseUrl}/tools`
   - ç®€å• SSE: è¿”å› JSON æ ¼å¼çš„å·¥å…·åˆ—è¡¨

### FastMCP æœåŠ¡ç¤ºä¾‹

ä½¿ç”¨ Python FastMCP åˆ›å»ºæœåŠ¡ï¼š

```python
from fastmcp import FastMCP

# åˆ›å»º MCP æœåŠ¡å™¨
mcp = FastMCP("My Tools")

@mcp.tool()
def search_web(query: str) -> str:
    """æœç´¢ç½‘ç»œå†…å®¹"""
    return f"æœç´¢ç»“æœ: {query}"

@mcp.tool()
def get_weather(city: str) -> str:
    """è·å–å¤©æ°”ä¿¡æ¯"""
    return f"{city} çš„å¤©æ°”: æ™´å¤©"

# å¯åŠ¨æœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£ 8000ï¼‰
if __name__ == "__main__":
    mcp.run(transport="sse")
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
python your_mcp_server.py
```

åœ¨æ‰©å±•è®¾ç½®ä¸­é…ç½®ï¼š
- **æœåŠ¡åç§°**: My Tools
- **SSE ç«¯ç‚¹ URL**: `http://127.0.0.1:8000/sse`
- **è¯·æ±‚æ–¹æ³•**: GETï¼ˆFastMCP ä½¿ç”¨ GET å»ºç«‹ SSE è¿æ¥ï¼‰

### FastMCP åè®®æ ¼å¼

**è¿æ¥æ–¹å¼**: GET è¯·æ±‚åˆ° SSE ç«¯ç‚¹

**å“åº”** (SSE stream):
```
data: {"tools":[{"name":"search_web","description":"æœç´¢ç½‘ç»œå†…å®¹","inputSchema":{"type":"object","properties":{"query":{"type":"string"}}}}]}

```

æˆ– JSON-RPC 2.0 æ ¼å¼:
```
data: {"jsonrpc":"2.0","result":{"tools":[...]}}

```

### æœåŠ¡å™¨è¦æ±‚

- **CORS æ”¯æŒ**: å¿…é¡»å…è®¸æ¥è‡ª `chrome-extension://` çš„è¯·æ±‚
- **å“åº”å¤´**:
  - `Content-Type: text/event-stream`
  - `Cache-Control: no-cache`
  - `Access-Control-Allow-Origin: *`
  - `Access-Control-Allow-Methods: POST, OPTIONS`
  - `Access-Control-Allow-Headers: Content-Type`

## æ³¨æ„äº‹é¡¹

- API Key ä¿å­˜åœ¨æœ¬åœ°ï¼Œè¯·å¦¥å–„ä¿ç®¡
- å¯¹è¯å†å²å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­
- MCP æœåŠ¡éœ€è¦æ”¯æŒ CORS
- é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½® Dify API

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
# soc-agent
